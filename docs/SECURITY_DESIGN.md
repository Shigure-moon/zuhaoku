# 安全架构设计文档

## 文档信息
- **版本**: v1.0
- **最后更新**: 2025/11/18
- **维护者**: shigure

---

## 一、安全架构概述

安全架构采用**纵深防御**策略，从网络、应用、数据多个层面保障系统安全。

详见架构图：`../diagrams/ZHK_C4_Security_Architecture.puml`

---

## 二、传输安全层

### 2.1 HTTPS/TLS 1.3
- 全站 HTTPS 加密
- 使用 TLS 1.3 协议
- 证书定期更新

### 2.2 API 签名验证
- 防止重放攻击
- 请求签名算法：HMAC-SHA256
- 时间戳验证（5分钟有效期）

### 2.3 WebSocket 加密
- 启动器通信使用 WSS（WebSocket Secure）
- 连接建立时验证 Token

---

## 三、应用安全层

### 3.1 身份认证

#### JWT Token
- **算法**: HS256
- **过期时间**: 24 小时
- **刷新机制**: 支持 Token 刷新
- **黑名单**: 退出登录时加入 Redis 黑名单

#### OAuth2 集成
- 支持微信快捷登录
- 支持支付宝快捷登录
- 第三方授权回调验证

### 3.2 权限控制

#### RBAC（基于角色的访问控制）
- **租客角色** (TENANT): 浏览账号、下单、支付
- **商家角色** (OWNER): 发布账号、管理订单、提现
- **运营角色** (OPERATOR): 数据统计、申诉处理、系统管理

#### 权限注解
```java
@PreAuthorize("hasRole('TENANT')")
@PreAuthorize("hasRole('OWNER')")
@PreAuthorize("hasAnyRole('TENANT', 'OWNER')")
```

### 3.3 密码加密
- **算法**: AES-256-GCM
- **密钥管理**: 存储在 KMS（阿里云 KMS/自建 Vault）
- **独立 IV**: 每账号使用独立的初始化向量

### 3.4 API 限流
- **工具**: Sentinel
- **策略**: 接口级限流
- **阈值**: 
  - 登录接口：5次/分钟
  - 下单接口：10次/分钟
  - 其他接口：100次/分钟

### 3.5 输入验证
- **参数校验**: 使用 Bean Validation
- **SQL 注入防护**: MyBatis 参数化查询
- **XSS 防护**: 前端输入验证 + 后端转义

---

## 四、数据安全层

### 4.1 敏感数据加密

#### 账号密码加密
- **算法**: AES-256-GCM
- **密钥派生**: 使用账号ID派生独立密钥
- **IV 存储**: 每个账号独立 IV，存储在数据库

#### 加密流程
```
明文密码 → AES-256-GCM 加密 → 密文 + IV → 存储到数据库
```

#### 解密流程
```
数据库读取 → 提取 IV → AES-256-GCM 解密 → 明文密码
```

### 4.2 数据脱敏
- **身份证号**: 仅存储 SHA-256 哈希值
- **手机号**: 日志中脱敏显示（如：138****5678）
- **银行卡号**: 不存储，仅用于支付时传递

### 4.3 密钥管理
- **KMS 服务**: 阿里云 KMS 或自建 Vault
- **密钥轮换**: 每 90 天轮换一次
- **密钥访问**: 仅应用服务可访问，不暴露给前端

### 4.4 数据备份加密
- **备份文件**: 使用 AES-256 加密
- **备份存储**: 加密后存储到对象存储
- **备份密钥**: 单独管理，与业务密钥分离

---

## 五、风控安全层

### 5.1 异地登录检测

#### 检测规则
- **距离阈值**: 登录 IP 与常用地距离 > 200km
- **触发动作**: 弹窗要求人脸识别验证
- **地理位置库**: 使用 GeoIP2 数据库

#### 多地登录检测
- **时间窗口**: 5 分钟内
- **触发条件**: 不同 IP 地址登录
- **处理动作**: 自动冻结账号并创建申诉

### 5.2 异常行为识别

#### 规则引擎
- **频繁下单取消**: 1小时内取消订单 > 3次
- **账号异常使用**: 启动器上报异常行为
- **支付异常**: 支付失败率 > 50%

#### 黑名单机制
- **设备指纹**: 记录设备唯一标识
- **IP 黑名单**: 记录恶意 IP
- **手机号黑名单**: 记录恶意用户手机号

### 5.3 资金安全

#### 浮动押金
```
浮动押金 = max(固定押金, 账号市场估价 × 30%)
```

#### 预授权机制
- **支付宝预授权**: 冻结花呗额度，平台不动用现金
- **预授权有效期**: 7 天
- **自动解冻**: 订单完成后自动解冻

#### 资金分账
- **分账时机**: 订单完成后 24 小时（T+1 结算）
- **分账比例**: 平台抽成 10%，号主获得 90%
- **分账记录**: 记录到 `settlement_record` 表

---

## 六、沙盒隔离层（P1 项目）

### 6.1 Windows Hyper-V Container
- **快照机制**: 每次租号生成一次性快照
- **快照销毁**: 租期结束后自动销毁
- **资源隔离**: CPU、内存、磁盘隔离

### 6.2 写屏蔽磁盘
- **写保护**: 快照销毁前禁止写入
- **只读模式**: 沙盒内文件系统只读
- **临时存储**: 使用临时磁盘存储运行时数据

### 6.3 内存加密
- **加密算法**: BitLocker
- **加密范围**: 运行时内存数据
- **密钥管理**: 每次租号生成临时密钥

### 6.4 网络隔离
- **网络限制**: 沙盒内网络访问受限
- **白名单**: 仅允许访问游戏服务器
- **DNS 过滤**: 过滤恶意域名

---

## 七、举证链设计

### 7.1 自动截图
- **触发时机**: 还号时自动触发
- **截图内容**: 游戏界面截图
- **存储位置**: MinIO 对象存储

### 7.2 自动录屏
- **录制时长**: 15 秒
- **录制内容**: 还号操作过程
- **视频格式**: MP4

### 7.3 哈希计算
- **算法**: SHA-256
- **计算内容**: 截图 + 录屏文件
- **存储位置**: 订单表的 `evidence_hash` 字段

### 7.4 区块链存证（M3 阶段）
- **上链内容**: 证据文件哈希
- **区块链**: 使用联盟链或公链
- **验证方式**: 公开验证，不可篡改

---

## 八、安全监控

### 8.1 日志记录
- **登录日志**: 记录所有登录尝试
- **操作日志**: 记录关键操作（下单、支付、还号）
- **异常日志**: 记录安全异常事件

### 8.2 告警机制
- **异常登录**: 异地登录、多地登录
- **异常支付**: 支付失败率异常
- **系统异常**: 系统错误、性能异常

### 8.3 安全审计
- **定期审计**: 每月执行安全审计
- **审计内容**: 权限变更、敏感操作、异常行为
- **审计报告**: 生成安全审计报告

---

## 九、安全合规

### 9.1 数据保护
- **个人信息保护法**: 遵循《个人信息保护法》
- **数据最小化**: 仅收集必要信息
- **用户同意**: 获取用户明确同意

### 9.2 支付合规
- **支付许可证**: 若月交易额 > 500万，需申请支付许可证
- **资金托管**: 与持牌机构合作（微信/支付宝收单+分账）
- **资金监管**: 定期接受资金监管

### 9.3 游戏合规
- **ToS 声明**: 明确告知用户游戏厂商服务条款
- **封禁险**: 提供账号封禁保险
- **风险提示**: 明确提示账号共享风险

---

## 十、安全事件响应

### 10.1 事件分类
- **P0 - 严重**: 数据泄露、系统被入侵
- **P1 - 高危**: 大量账号被盗、支付异常
- **P2 - 中危**: 单个账号异常、API 被攻击
- **P3 - 低危**: 异常登录、可疑行为

### 10.2 响应流程
1. **发现**: 监控系统发现安全事件
2. **评估**: 评估事件严重程度
3. **响应**: 执行应急响应措施
4. **恢复**: 恢复系统正常运行
5. **复盘**: 安全事件复盘，改进防护措施

---

## 十一、参考资源

- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [PCI DSS 标准](https://www.pcisecuritystandards.org/)
- [个人信息保护法](https://www.npc.gov.cn/)

---

**文档维护**: shigure  
**最后更新**: 2025/11/18

